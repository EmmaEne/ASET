<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - ASET TAMP</title>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="dashboard-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" style="background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);">
            <div class="sidebar-header">
                <a href="superadmin.html" class="sidebar-brand">
                    <div class="logo-icon" style="background: rgba(255,255,255,0.1);">A</div>
                    <span>ASET</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                    <a href="#dashboard" class="nav-item active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#activity" class="nav-item" data-page="activity">
                        <i class="fas fa-history"></i>
                        <span>Activity Log</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <a href="#cases" class="nav-item" data-page="cases">
                        <i class="fas fa-folder-open"></i>
                        <span>All Cases</span>
                    </a>
                    <a href="#users" class="nav-item" data-page="users">
                        <i class="fas fa-users-cog"></i>
                        <span>User Management</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Security</div>
                    <a href="#audit" class="nav-item" data-page="audit">
                        <i class="fas fa-shield-alt"></i>
                        <span>Audit Trail</span>
                    </a>
                    <a href="#locks" class="nav-item" data-page="locks">
                        <i class="fas fa-lock"></i>
                        <span>Case Locks</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">System</div>
                    <a href="#settings" class="nav-item" data-page="settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-menu" id="userMenu"></div>
            </div>
        </aside>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <header class="topbar">
                <div class="topbar-left">
                    <button class="sidebar-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">Super Admin Dashboard</h1>
                </div>
                <div class="topbar-right">
                    <span class="badge badge-danger">
                        <i class="fas fa-shield-alt"></i> Super Admin
                    </span>
                    <button class="notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Dashboard Page -->
                <div class="page-section active" id="dashboard-page">
                    <!-- Alert Banner -->
                    <div class="alert-banner mb-4">
                        <i class="fas fa-shield-alt"></i>
                        <span>You have full system access. All actions are logged and audited.</span>
                    </div>

                    <!-- Stats Row -->
                    <div class="row g-4 mb-6">
                        <div class="col-6 col-lg-3">
                            <div class="stat-card">
                                <div class="stat-icon primary">
                                    <i class="fas fa-folder"></i>
                                </div>
                                <div class="stat-value" id="statTotalCases">0</div>
                                <div class="stat-label">Total Cases</div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="stat-card success">
                                <div class="stat-icon success">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-value" id="statTotalUsers">0</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="stat-card warning">
                                <div class="stat-icon warning">
                                    <i class="fas fa-lock"></i>
                                </div>
                                <div class="stat-value" id="statLockedCases">0</div>
                                <div class="stat-label">Locked Cases</div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="stat-card">
                                <div class="stat-icon primary">
                                    <i class="fas fa-history"></i>
                                </div>
                                <div class="stat-value" id="statLogEntries">0</div>
                                <div class="stat-label">Log Entries</div>
                            </div>
                        </div>
                    </div>

                    <!-- System Overview -->
                    <div class="row g-4 mb-6">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Recent System Activity</h3>
                                    <button class="btn btn-sm btn-secondary" onclick="showPage('activity')">View
                                        All</button>
                                </div>
                                <div class="card-body p-0">
                                    <div class="activity-feed" id="recentActivityFeed"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h3 class="card-title">User Distribution</h3>
                                </div>
                                <div class="card-body" id="userDistribution"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <button class="btn btn-outline-primary w-100 py-3" onclick="showPage('activity')">
                                        <i class="fas fa-history"></i><br>
                                        View Activity Log
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-outline-primary w-100 py-3" onclick="showPage('locks')">
                                        <i class="fas fa-lock"></i><br>
                                        Manage Case Locks
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-outline-primary w-100 py-3" onclick="showPage('audit')">
                                        <i class="fas fa-shield-alt"></i><br>
                                        View Audit Trail
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Log Page -->
                <div class="page-section" id="activity-page">
                    <!-- Filters -->
                    <div class="filter-bar mb-4">
                        <div class="filter-group">
                            <label class="filter-label">Action Type:</label>
                            <select class="filter-select" id="filterAction">
                                <option value="">All Actions</option>
                                <option value="login">Login</option>
                                <option value="case_created">Case Created</option>
                                <option value="case_assigned">Case Assigned</option>
                                <option value="stage_updated">Stage Updated</option>
                                <option value="note_added">Note Added</option>
                                <option value="case_locked">Case Locked</option>
                                <option value="case_unlocked">Case Unlocked</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">User:</label>
                            <select class="filter-select" id="filterUser">
                                <option value="">All Users</option>
                            </select>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="applyActivityFilters()">
                            <i class="fas fa-filter"></i> Apply
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="clearActivityFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Complete Activity Log</h3>
                            <span class="badge badge-secondary" id="logCount">0 entries</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>User</th>
                                            <th>Action</th>
                                            <th>Details</th>
                                            <th>Case ID</th>
                                        </tr>
                                    </thead>
                                    <tbody id="activityTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cases Page -->
                <div class="page-section" id="cases-page">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All System Cases</h3>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Case ID</th>
                                            <th>Student</th>
                                            <th>Request Type</th>
                                            <th>Status</th>
                                            <th>Officer</th>
                                            <th>Locked</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="casesTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Page -->
                <div class="page-section" id="users-page">
                    <div class="row g-4 mb-4">
                        <div class="col-md-6 col-lg-3">
                            <div class="stat-card">
                                <div class="stat-icon primary"><i class="fas fa-user-graduate"></i></div>
                                <div class="stat-value" id="userCountStudents">0</div>
                                <div class="stat-label">Students</div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="stat-card success">
                                <div class="stat-icon success"><i class="fas fa-user-tie"></i></div>
                                <div class="stat-value" id="userCountOfficers">0</div>
                                <div class="stat-label">Officers</div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="stat-card warning">
                                <div class="stat-icon warning"><i class="fas fa-chalkboard-teacher"></i></div>
                                <div class="stat-value" id="userCountMentors">0</div>
                                <div class="stat-label">Mentors</div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="stat-card danger">
                                <div class="stat-icon danger"><i class="fas fa-user-shield"></i></div>
                                <div class="stat-value" id="userCountAdmins">0</div>
                                <div class="stat-label">Admins</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Users</h3>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Created</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audit Trail Page -->
                <div class="page-section" id="audit-page">
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center gap-3">
                                <div class="stat-icon danger" style="width: 48px; height: 48px;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">Audit Trail - Immutable Record</h5>
                                    <p class="text-muted mb-0">This is a complete, tamper-proof record of all system
                                        actions. No records can be deleted or altered.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Critical Actions Audit</h3>
                        </div>
                        <div class="card-body p-0" id="auditTrailContent"></div>
                    </div>
                </div>

                <!-- Case Locks Page -->
                <div class="page-section" id="locks-page">
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-lock text-danger"></i> Locked Cases</h3>
                                </div>
                                <div class="card-body p-0" id="lockedCasesList"></div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-unlock text-success"></i> Unlocked Cases
                                    </h3>
                                </div>
                                <div class="card-body p-0" id="unlockedCasesList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div class="page-section" id="settings-page">
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">System Settings</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Service Fee (₦)</label>
                                        <input type="number" class="form-control" value="5000" disabled>
                                        <div class="form-text">Contact system administrator to change fees</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Max Upload Size (MB)</label>
                                        <input type="number" class="form-control" value="10" disabled>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input type="checkbox" class="form-check-input" checked disabled>
                                        <label class="form-check-label">Enable Email Notifications</label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input type="checkbox" class="form-check-input" checked disabled>
                                        <label class="form-check-label">Enable Activity Logging</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Data Management</h3>
                                </div>
                                <div class="card-body">
                                    <button class="btn btn-outline-primary w-100 mb-3" onclick="exportData()">
                                        <i class="fas fa-download"></i> Export All Data
                                    </button>
                                    <button class="btn btn-outline-warning w-100 mb-3" onclick="clearDemoData()">
                                        <i class="fas fa-trash"></i> Clear Demo Data
                                    </button>
                                    <button class="btn btn-outline-success w-100" onclick="resetToDefault()">
                                        <i class="fas fa-redo"></i> Reset to Default
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Case Detail Modal -->
    <div class="modal-backdrop" id="caseModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Case Details</h3>
                <button class="modal-close" onclick="closeModal('caseModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="caseModalContent"></div>
            <div class="modal-footer" id="caseModalFooter"></div>
        </div>
    </div>

    <style>
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .alert-banner {
            background: linear-gradient(90deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            border-radius: var(--radius-lg);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #92400e;
            font-weight: 500;
        }

        .alert-banner i {
            font-size: 1.25rem;
        }

        .action-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 20px;
            text-transform: uppercase;
        }

        .action-login {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .action-case_created {
            background: #d1fae5;
            color: #059669;
        }

        .action-case_assigned {
            background: #fef3c7;
            color: #d97706;
        }

        .action-stage_updated {
            background: #e0e7ff;
            color: #4f46e5;
        }

        .action-note_added {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .action-case_locked {
            background: #fee2e2;
            color: #dc2626;
        }

        .action-case_unlocked {
            background: #d1fae5;
            color: #059669;
        }

        .lock-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .lock-item:last-child {
            border-bottom: none;
        }

        .user-distribution-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .user-distribution-item:last-child {
            border-bottom: none;
        }

        .distribution-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-100);
            border-radius: 4px;
            overflow: hidden;
        }

        .distribution-fill {
            height: 100%;
            border-radius: 4px;
        }
    </style>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        let currentUser = null;
        let selectedCase = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            currentUser = ASET.requireAuth(['superadmin']);
            if (!currentUser) return;

            ASET.renderUserInfo(currentUser);

            setupNavigation();
            loadDashboard();
            populateUserFilter();
        });

        // Navigation
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(item.dataset.page);
                });
            });
        }

        function showPage(page) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });

            const titles = {
                'dashboard': 'Super Admin Dashboard',
                'activity': 'Activity Log',
                'cases': 'All Cases',
                'users': 'User Management',
                'audit': 'Audit Trail',
                'locks': 'Case Locks',
                'settings': 'System Settings'
            };
            document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';

            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`${page}-page`).classList.add('active');

            if (page === 'dashboard') loadDashboard();
            if (page === 'activity') loadActivityLog();
            if (page === 'cases') loadCases();
            if (page === 'users') loadUsers();
            if (page === 'audit') loadAuditTrail();
            if (page === 'locks') loadCaseLocks();
        }

        // Dashboard
        function loadDashboard() {
            const cases = ASET.getCases();
            const users = ASET.getUsers();
            const logs = ASET.getActivityLogs();

            document.getElementById('statTotalCases').textContent = cases.length;
            document.getElementById('statTotalUsers').textContent = users.length;
            document.getElementById('statLockedCases').textContent = cases.filter(c => c.isLocked).length;
            document.getElementById('statLogEntries').textContent = logs.length;

            // User distribution
            const distribution = {
                student: users.filter(u => u.role === 'student').length,
                officer: users.filter(u => u.role === 'officer').length,
                mentor: users.filter(u => u.role === 'mentor').length,
                admin: users.filter(u => u.role === 'admin' || u.role === 'superadmin').length
            };
            const maxUsers = Math.max(...Object.values(distribution), 1);

            const colors = { student: '#6366f1', officer: '#10b981', mentor: '#f59e0b', admin: '#ef4444' };
            document.getElementById('userDistribution').innerHTML = Object.entries(distribution).map(([role, count]) => `
        <div class="user-distribution-item">
          <span style="width: 70px; text-transform: capitalize; font-weight: 500;">${role}s</span>
          <div class="distribution-bar">
            <div class="distribution-fill" style="width: ${(count / maxUsers) * 100}%; background: ${colors[role]}"></div>
          </div>
          <span class="fw-600" style="width: 30px; text-align: right;">${count}</span>
        </div>
      `).join('');

            // Recent activity
            renderActivityFeed('recentActivityFeed', logs.slice(0, 10));
        }

        // Activity Log
        function populateUserFilter() {
            const users = ASET.getUsers();
            document.getElementById('filterUser').innerHTML =
                '<option value="">All Users</option>' +
                users.map(u => `<option value="${u.id}">${u.fullName}</option>`).join('');
        }

        function loadActivityLog(filters = {}) {
            const logs = ASET.getActivityLogs(filters);
            document.getElementById('logCount').textContent = `${logs.length} entries`;

            document.getElementById('activityTableBody').innerHTML = logs.map(log => `
        <tr>
          <td>
            <div class="fw-500">${ASET.formatDateTime(log.timestamp)}</div>
          </td>
          <td>${log.userName}</td>
          <td><span class="action-badge action-${log.action}">${formatAction(log.action)}</span></td>
          <td>${log.details}</td>
          <td>${log.caseId ? `<span class="case-id">${log.caseId}</span>` : '-'}</td>
        </tr>
      `).join('');
        }

        function formatAction(action) {
            const actions = {
                'login': 'Login',
                'register': 'Register',
                'case_created': 'Case Created',
                'case_assigned': 'Assigned',
                'stage_updated': 'Stage Update',
                'note_added': 'Note Added',
                'mentor_assigned': 'Mentor Assigned',
                'case_locked': 'Locked',
                'case_unlocked': 'Unlocked'
            };
            return actions[action] || action;
        }

        function applyActivityFilters() {
            const filters = {};
            const action = document.getElementById('filterAction').value;
            const userId = document.getElementById('filterUser').value;

            if (action) filters.action = action;
            if (userId) filters.userId = userId;

            loadActivityLog(filters);
        }

        function clearActivityFilters() {
            document.getElementById('filterAction').value = '';
            document.getElementById('filterUser').value = '';
            loadActivityLog();
        }

        function renderActivityFeed(containerId, logs) {
            const container = document.getElementById(containerId);
            container.innerHTML = logs.map(log => `
        <div class="activity-item">
          <div class="activity-icon">
            <i class="${getActivityIcon(log.action)}"></i>
          </div>
          <div class="activity-content">
            <div class="activity-text">
              <strong>${log.userName}</strong> ${log.details}
              ${log.caseId ? `<span class="case-id">(${log.caseId})</span>` : ''}
            </div>
            <div class="activity-time">${ASET.formatDateTime(log.timestamp)}</div>
          </div>
        </div>
      `).join('');
        }

        function getActivityIcon(action) {
            const icons = {
                'login': 'fas fa-sign-in-alt',
                'register': 'fas fa-user-plus',
                'case_created': 'fas fa-folder-plus',
                'case_assigned': 'fas fa-user-tag',
                'stage_updated': 'fas fa-arrow-right',
                'note_added': 'fas fa-sticky-note',
                'mentor_assigned': 'fas fa-chalkboard-teacher',
                'case_locked': 'fas fa-lock',
                'case_unlocked': 'fas fa-unlock'
            };
            return icons[action] || 'fas fa-circle';
        }

        // Cases
        function loadCases() {
            const cases = ASET.getCases();
            const officers = ASET.getUsers('officer');

            document.getElementById('casesTableBody').innerHTML = cases.map(c => {
                const officer = officers.find(o => o.id === c.assignedOfficer);
                return `
          <tr>
            <td><span class="case-id" style="cursor: pointer;" onclick="viewCase('${c.id}')">${c.id}</span></td>
            <td>
              <div class="fw-500">${c.studentName}</div>
              <div class="text-muted" style="font-size: 0.85rem;">${c.matricNumber}</div>
            </td>
            <td>${ASET.getRequestTypeLabel(c.requestType)}</td>
            <td>${ASET.renderStatusBadge(c.currentStage)}</td>
            <td>${officer ? officer.fullName : '<span class="text-muted">Unassigned</span>'}</td>
            <td>
              ${c.isLocked
                        ? '<span class="badge badge-danger"><i class="fas fa-lock"></i> Locked</span>'
                        : '<span class="badge badge-success"><i class="fas fa-unlock"></i> Open</span>'}
            </td>
            <td>
              <div class="d-flex gap-2">
                <button class="btn btn-icon btn-sm btn-secondary" onclick="viewCase('${c.id}')" title="View">
                  <i class="fas fa-eye"></i>
                </button>
                ${c.isLocked
                        ? `<button class="btn btn-icon btn-sm btn-success" onclick="unlockCase('${c.id}')" title="Unlock">
                      <i class="fas fa-unlock"></i>
                    </button>`
                        : `<button class="btn btn-icon btn-sm btn-danger" onclick="lockCase('${c.id}')" title="Lock">
                      <i class="fas fa-lock"></i>
                    </button>`
                    }
              </div>
            </td>
          </tr>
        `;
            }).join('');
        }

        function viewCase(caseId) {
            selectedCase = ASET.getCaseById(caseId);
            if (!selectedCase) return;

            const officer = selectedCase.assignedOfficer ? ASET.getUserById(selectedCase.assignedOfficer) : null;
            const logs = ASET.getActivityLogs({ caseId: caseId });

            document.getElementById('caseModalContent').innerHTML = `
        <div class="d-flex justify-content-between align-items-start mb-4">
          <div>
            <span class="case-id" style="font-size: 1.1rem;">${selectedCase.id}</span>
            ${selectedCase.isLocked ? '<span class="badge badge-danger ms-2"><i class="fas fa-lock"></i> LOCKED</span>' : ''}
          </div>
          ${ASET.renderStatusBadge(selectedCase.currentStage)}
        </div>
        
        <div class="stepper mb-4">
          ${ASET.renderStepper(selectedCase.currentStage)}
        </div>
        
        <div class="row g-4 mb-4">
          <div class="col-md-6">
            <div class="p-3 rounded" style="background: var(--gray-50);">
              <h6 class="text-muted mb-2">Student</h6>
              <div class="fw-600">${selectedCase.studentName}</div>
              <div class="text-muted">${selectedCase.matricNumber}</div>
              <div class="text-muted">${selectedCase.faculty} • ${selectedCase.department}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="p-3 rounded" style="background: var(--gray-50);">
              <h6 class="text-muted mb-2">Request</h6>
              <div class="fw-600">${ASET.getRequestTypeLabel(selectedCase.requestType)}</div>
              <div class="text-muted">Officer: ${officer ? officer.fullName : 'Unassigned'}</div>
              <div class="text-muted">Created: ${ASET.formatDate(selectedCase.createdAt)}</div>
            </div>
          </div>
        </div>
        
        <h6 class="mb-3">Case Activity Log (${logs.length} entries)</h6>
        <div style="max-height: 300px; overflow-y: auto;">
          ${logs.map(log => `
            <div class="d-flex align-items-start gap-3 p-2 border-bottom">
              <span class="action-badge action-${log.action}" style="flex-shrink: 0;">${formatAction(log.action)}</span>
              <div class="flex-grow-1">
                <div class="fw-500">${log.userName}</div>
                <div class="text-muted" style="font-size: 0.85rem;">${log.details}</div>
              </div>
              <div class="text-muted text-end" style="font-size: 0.8rem; flex-shrink: 0;">
                ${ASET.formatDateTime(log.timestamp)}
              </div>
            </div>
          `).join('')}
        </div>
      `;

            document.getElementById('caseModalFooter').innerHTML = `
        ${selectedCase.isLocked
                    ? `<button class="btn btn-success" onclick="unlockCase('${selectedCase.id}'); closeModal('caseModal');">
              <i class="fas fa-unlock"></i> Unlock Case
            </button>`
                    : `<button class="btn btn-danger" onclick="lockCase('${selectedCase.id}'); closeModal('caseModal');">
              <i class="fas fa-lock"></i> Lock Case
            </button>`
                }
      `;

            openModal('caseModal');
        }

        function lockCase(caseId) {
            ASET.toggleCaseLock(caseId, true, currentUser.id, currentUser.fullName);
            ASET.showToast('Case locked successfully', 'success');
            loadCases();
            loadCaseLocks();
        }

        function unlockCase(caseId) {
            ASET.toggleCaseLock(caseId, false, currentUser.id, currentUser.fullName);
            ASET.showToast('Case unlocked successfully', 'success');
            loadCases();
            loadCaseLocks();
        }

        // Users
        function loadUsers() {
            const users = ASET.getUsers();

            document.getElementById('userCountStudents').textContent = users.filter(u => u.role === 'student').length;
            document.getElementById('userCountOfficers').textContent = users.filter(u => u.role === 'officer').length;
            document.getElementById('userCountMentors').textContent = users.filter(u => u.role === 'mentor').length;
            document.getElementById('userCountAdmins').textContent = users.filter(u => u.role === 'admin' || u.role === 'superadmin').length;

            document.getElementById('usersTableBody').innerHTML = users.map(u => `
        <tr>
          <td class="fw-500">${u.fullName}</td>
          <td>${u.email}</td>
          <td>
            <span class="badge badge-${u.role === 'superadmin' ? 'danger' :
                    u.role === 'admin' ? 'warning' :
                        u.role === 'officer' ? 'success' :
                            u.role === 'mentor' ? 'info' : 'primary'
                }">${u.role}</span>
          </td>
          <td>${ASET.formatDate(u.createdAt)}</td>
          <td><span class="badge badge-success">Active</span></td>
        </tr>
      `).join('');
        }

        // Audit Trail
        function loadAuditTrail() {
            // Filter for critical actions
            const logs = ASET.getActivityLogs().filter(log =>
                ['case_locked', 'case_unlocked', 'stage_updated', 'case_assigned'].includes(log.action)
            );

            document.getElementById('auditTrailContent').innerHTML = logs.length === 0
                ? '<div class="p-4 text-center text-muted">No critical actions recorded</div>'
                : logs.map(log => `
          <div class="d-flex align-items-center gap-4 p-4 border-bottom">
            <div class="stat-icon ${log.action.includes('lock') ? 'danger' : 'primary'}" style="width: 40px; height: 40px;">
              <i class="${getActivityIcon(log.action)}"></i>
            </div>
            <div class="flex-grow-1">
              <div class="fw-600">${log.userName}</div>
              <div class="text-muted">${log.details}</div>
            </div>
            ${log.caseId ? `<span class="case-id">${log.caseId}</span>` : ''}
            <div class="text-muted text-end">
              ${ASET.formatDateTime(log.timestamp)}
            </div>
          </div>
        `).join('');
        }

        // Case Locks
        function loadCaseLocks() {
            const cases = ASET.getCases();
            const locked = cases.filter(c => c.isLocked);
            const unlocked = cases.filter(c => !c.isLocked);

            document.getElementById('lockedCasesList').innerHTML = locked.length === 0
                ? '<div class="p-4 text-center text-muted">No locked cases</div>'
                : locked.map(c => `
          <div class="lock-item">
            <div class="flex-grow-1">
              <span class="case-id">${c.id}</span>
              <div class="text-muted">${c.studentName}</div>
            </div>
            <button class="btn btn-sm btn-success" onclick="unlockCase('${c.id}')">
              <i class="fas fa-unlock"></i> Unlock
            </button>
          </div>
        `).join('');

            document.getElementById('unlockedCasesList').innerHTML = unlocked.slice(0, 10).map(c => `
        <div class="lock-item">
          <div class="flex-grow-1">
            <span class="case-id">${c.id}</span>
            <div class="text-muted">${c.studentName}</div>
          </div>
          <button class="btn btn-sm btn-danger" onclick="lockCase('${c.id}')">
            <i class="fas fa-lock"></i> Lock
          </button>
        </div>
      `).join('');
        }

        // Data Management
        function exportData() {
            const data = {
                users: ASET.getUsers(),
                cases: ASET.getCases(),
                activityLog: ASET.getActivityLogs(),
                exportedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aset-export-${Date.now()}.json`;
            a.click();

            ASET.showToast('Data exported successfully!', 'success');
        }

        function clearDemoData() {
            if (confirm('This will clear all demo data. Are you sure?')) {
                localStorage.clear();
                ASET.showToast('Demo data cleared. Refreshing...', 'success');
                setTimeout(() => location.reload(), 1000);
            }
        }

        function resetToDefault() {
            if (confirm('This will reset the system to default demo state. Are you sure?')) {
                localStorage.clear();
                location.reload();
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = '';
        }
    </script>
</body>

</html>